<?xml version="1.0" encoding="UTF-8"?><databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">	<changeSet id="addEcNewsPriority" author="zhangwenyun">		<addColumn tableName="ec_news">			<column name="priority" type="int(11)"></column>		</addColumn>	</changeSet>	<changeSet id="newsPriority" author="zhangwenyun">		<sql>			update ec_news set priority = 999999;		</sql>	</changeSet>	<changeSet id="addEc_project_user" author="zhangwenyun">		<createTable tableName="ec_project_user">			<column name="id" type="varchar(128)">				<constraints primaryKey="true" />			</column>			<column name="projectId" type="varchar(128)">				<constraints nullable="false" />			</column>			<column name="project_invest_id" type="varchar(128)">				<constraints nullable="false" />			</column>			<column name="userid" type="varchar(128)">				<constraints nullable="false" />			</column>			<column name="mobileNumber" type="varchar(12)">				<constraints nullable="false" />			</column>			<column name="count" type="int(11)">				<constraints nullable="false" />			</column>			<column name="price" type="DECIMAL(16,2)">				<constraints nullable="false" />			</column>			<column name="amount" type="DECIMAL(16,2)">				<constraints nullable="false" />			</column>			<column name="realAmount" type="DECIMAL(16,2)">				<constraints nullable="false" />			</column>			<column name="remark" type="varchar(255)"></column>			<column name="createTime" type="datetime">				<constraints nullable="false" />			</column>			<column name="successTime" type="datetime">				<constraints nullable="false" />			</column>			<column name="orderBy" type="int(11)"></column>			<column name="status" type="int(11)">				<constraints nullable="false" />			</column>		</createTable>		<createIndex tableName="ec_project_user" indexName="idx_projecid">			<column name="projectId" type="varchar(128)"></column>		</createIndex>		<createIndex tableName="ec_project_user" indexName="idx_project_investid">			<column name="project_invest_id" type="varchar(128)"></column>		</createIndex>		<createIndex tableName="ec_project_user" indexName="idx_projectuser_userid">			<column name="userid" type="varchar(128)"></column>		</createIndex>		<createIndex tableName="ec_project_user" indexName="idx_projectuser_mobileNumber">			<column name="mobileNumber" type="varchar(12)"></column>		</createIndex>	</changeSet>	<changeSet id="projectInvest" author="hepei">		<createTable tableName="ec_project_invest">			<column name="id" type="varchar(128)">				<constraints primaryKey="true" />			</column>			<column name="project_id" type="varchar(255)"></column>			<column name="amount" type="DECIMAL(16,2)"></column>			<column name="support_num" type="int"></column>			<column name="content" type="varchar(2000)"></column>			<column name="orderbyId" type="int"></column>			<column name="benefit_amount" type="DECIMAL(16,2)"></column>			<column name="invest_name" type="varchar(255)"></column>			<column name="miss_benefit_amount" type="DECIMAL(16,2)"></column>			<column name="already_support_num" type="int" defaultValue="0"></column>		</createTable>		<sql>			INSERT INTO `ec_resource`			(`TYPE`,`VALUE`,			`MODEL_NAME`,			`PARENT_ID`,			`createTime`,			`createBy`,			`lastUpdateTime`,			`lastUpdateBy`)			VALUES (NULL,			'/manager/adminProjectList.html',			'众筹平台设置',			0,			'2013-11-06			09:02:59',			'13512529243',			'2013-11-06 09:02:59',			'13512529243')		</sql>		<sql>			INSERT INTO `ec_resource`			(`TYPE`,`VALUE`,			`MODEL_NAME`,			`PARENT_ID`,			`createTime`,			`createBy`,			`lastUpdateTime`,			`lastUpdateBy`)			VALUES (NULL,			'/manager/adminProjectTypeList.html',			'众筹类别设置',			0,			'2013-11-06 09:02:59',			'13512529243',			'2013-11-06 09:02:59',			'13512529243')		</sql>		<createIndex tableName="ec_project_invest" indexName="ec_project_invest_projectId">			<column name="project_id" type="varchar(255)"></column>		</createIndex>	</changeSet>	<changeSet id="project" author="xupei">		<createTable tableName="ec_project">			<column name="id" type="varchar(255)">				<constraints primaryKey="true" />			</column>			<column name="name" type="varchar(500)"></column>			<column name="namedesc" type="varchar(1000)"></column>			<column name="endtime" type="datetime"></column>			<column name="goalmoney" type="double(11,2)"></column>			<column name="projectdesc" type="text"></column>			<column name="explanation" type="varchar(1000)"></column>			<column name="type" type="varchar(255)"></column>			<column name="projectpic" type="mediumblob">				<constraints nullable="true" />			</column>			<column name="addr" type="varchar(255)"></column>			<column name="createtime" type="datetime">				<constraints nullable="true" />			</column>			<column name="days" type="int(11)"></column>			<column name="daysdate" type="datetime">				<constraints nullable="true" />			</column>			<column name="status" type="int(11)"></column>		</createTable>		<createTable tableName="ec_project_type">			<column name="id" type="varchar(255)">				<constraints primaryKey="true" />			</column>			<column name="name" type="varchar(255)"></column>		</createTable>		<sql>			DROP VIEW IF EXISTS ec_project_user_view;		</sql>		<createView viewName="ec_project_user_view">        SELECT		sum(b.realAmount) sumamount,		b.projectid,		SUM(b.count) persons	    FROM		ec_project_user b where b.`status` = 2	    GROUP BY		b.projectid	</createView>		<sql>			DROP VIEW IF EXISTS ec_project_user_detail_view;		</sql>		<createView viewName="ec_project_user_detail_view">	SELECT	sum(a.realAmount) sumamount,a.mobileNumber,a.projectId,max(a.createTime) lastTime    FROM	ec_project_user a where a.`status` = 2    GROUP BY	a.mobileNumber,a.projectId	</createView>		<sql>			DROP VIEW IF EXISTS ec_project_view;		</sql>		<createView viewName="ec_project_view">	SELECT	a.*, datediff(a.endtime, now())enddays,	COALESCE(c.sumamount, 0)sumamount,	COALESCE(c.persons, 0)persons,	COALESCE(sumamount * 100 / a.goalmoney,0) scale    FROM	ec_project a    LEFT JOIN ec_project_user_view c ON a.id = c.projectid	</createView>		<sql>			DROP VIEW IF EXISTS ec_project_user_process_view;		</sql>		<createView viewName="ec_project_user_process_view">	SELECT	a.realAmount sumAmount,	a.mobileNumber,	a.projectId,	a.project_invest_id,    a.count sumcount,    a.successTime    FROM	ec_project_user a where a.`status` = 2 and a.projectId  in (select id from ec_project where `status` != 1)	</createView>		<sql>			DROP VIEW IF EXISTS ec_project_process_view;		</sql>		<createView viewName="ec_project_process_view">	SELECT	a.sumamount,	a.mobilenumber,	b.endtime,	b.daysdate,	c.miss_benefit_amount * a.sumcount * DATEDIFF(b.endtime,a.successTime)/DATEDIFF(b.endtime,b.createtime) miss_benefit_amount,	c.benefit_amount * a.sumcount benefit_amount,	b.goalmoney,	d.sumamount allsumamount,    b.`name`,    b.id    FROM	ec_project_user_process_view a    LEFT JOIN ec_project b ON a.projectid = b.id    LEFT JOIN ec_project_invest c ON c.id = a.project_invest_id    LEFT JOIN ec_project_user_view d ON a.projectid = d.projectid	</createView>		<sql>			DROP PROCEDURE IF EXISTS proc_project;		</sql>		<createProcedure>	<![CDATA[ 	CREATE  PROCEDURE `proc_project`()    BEGIN			declare _sumamount DOUBLE;			declare _endtime datetime;            declare _mobilenumber varchar(255);			declare _daysdate datetime;            declare _miss_benefit_amount DOUBLE;            declare _benefit_amount DOUBLE;            declare _goalmoney DOUBLE;            declare _allsumamount DOUBLE;            declare _name varchar(255);            declare _id varchar(255);            declare _banance decimal(16,4);            declare _userid varchar(255);            declare serialNumber VARCHAR(255);            declare randNumber VARCHAR(255);            declare uuidnum VARCHAR(255);            DECLARE nowtime datetime;			declare fetchSeqOk boolean;			declare cur1 CURSOR FOR select * from ec_project_process_view;			declare continue handler for NOT FOUND set fetchSeqOk = true;			set fetchSeqOk = false;            SET nowtime=NOW();			open cur1;			fetchSeqLoop:Loop			FETCH cur1 INTO			_sumamount,_mobilenumber,_endtime,_daysdate,_miss_benefit_amount,_benefit_amount,_goalmoney,_allsumamount,_name,_id;			if fetchSeqOk then			leave			fetchSeqLoop;			else            SELECT id from ec_user where mobilenumber = _mobilenumber into _userid;                   if  nowtime >= _endtime THEN                    select date_format(now(),'%Y%m%d%H%i%s') into serialNumber;			        select round(rand()*10000) into randNumber;			        set serialNumber = serialNumber+randNumber;                    select uuid() into uuidnum;                if _allsumamount < _goalmoney THEN                   update ec_user_wallet set amount = amount + _miss_benefit_amount where userid = _userid;                   select amount from ec_user_wallet where userid = _userid into _banance;                   insert into ec_deal_detail (id,serialNumber,datetime,status,amount,balance,userid,description,detailtype,type)values(uuidnum,CONCAT('Z',serialNumber),now(),0,_miss_benefit_amount,_banance,_userid,CONCAT('用户获取收益，项目名称为',_name),0,1);                                ELSE                                        if  nowtime >= _daysdate THEN                    update ec_user_wallet set amount = amount + _benefit_amount where userid = _userid;                    select amount from ec_user_wallet where userid = _userid into _banance;                    insert into ec_deal_detail (id,serialNumber,datetime,status,amount,balance,userid,description,detailtype,type)values(uuidnum,CONCAT('Z',serialNumber),now(),0,_benefit_amount,_banance,_userid,CONCAT('用户获取收益，项目名称为',_name),0,1);                                    end if;                                    end if;                                          select date_format(now(),'%Y%m%d%H%i%s') into serialNumber;			        select round(rand()*10000) into randNumber;			        set serialNumber = serialNumber+randNumber;                    select uuid() into uuidnum;                                          update ec_user_wallet set amount = amount + _sumamount where userid = _userid;                    select amount from ec_user_wallet where userid = _userid into _banance;                    insert into ec_deal_detail (id,serialNumber,datetime,status,amount,balance,userid,description,detailtype,type)values(uuidnum,CONCAT('Z',serialNumber),now(),0,_sumamount,_banance,_userid,CONCAT('用户获取本金，项目名称为',_name),0,1);                        update ec_project set status = 1 where id =  _id;                    end if;						end if;			end Loop;			close cur1;			end			]]>		</createProcedure>		<sql>			DROP EVENT IF EXISTS PROJECT_EVENT;		</sql>		<createProcedure>			CREATE EVENT PROJECT_EVENT ON SCHEDULE EVERY 1 DAY			STARTS '2013-06-25			00:00:00' ON COMPLETION			NOT PRESERVE ENABLE DO			call			proc_project();		</createProcedure>	</changeSet>	<changeSet id="addBankData" author="zhangwenyun">		<sql>insert into ec_bank(bankId,bankName,shortName) values (10000,'中国工商银行','ICBC');</sql>		<sqlFile path="/Users/zhangwenyun/Documents/efinance/src/test/resources/subbank.sql" />		<sqlFile path="/Users/zhangwenyun/Documents/efinance/src/test/resources/citybankmap.sql" />	</changeSet></databaseChangeLog>